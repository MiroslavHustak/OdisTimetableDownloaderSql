USE TimetableDownloader;
GO

DROP TABLE TimetableLinks;
GO

CREATE TABLE TimetableLinks
(       
    OldPrefix NVARCHAR(50),
	NewPrefix NVARCHAR(50),
    StartDate DATE,
    EndDate DATE,
    TotalDateInterval NVARCHAR(50),
    VT_Suffix NVARCHAR(50),
    JS_GeneratedString NVARCHAR(50),
    CompleteLink NVARCHAR(100) NOT NULL,
    FileToBeSaved NVARCHAR(100)    
);

//***********************************************
CREATE FUNCTION dbo.ITVF_GetLinksCurrentValidity ()   
RETURNS TABLE
AS
RETURN 
(
    SELECT NewPrefix, StartDate, CompleteLink, FileToBeSaved, MaxRow
    FROM
	(
        SELECT NewPrefix, StartDate, EndDate, CompleteLink, FileToBeSaved,
		ROW_NUMBER() OVER (PARTITION BY NewPrefix ORDER BY StartDate DESC) AS MaxRow
        FROM TimetableLinks
		WHERE 	    
        ((StartDate <= FORMAT(GETDATE(), 'yyyy-MM-dd') AND EndDate >= FORMAT(GETDATE(), 'yyyy-MM-dd'))
        OR
        (StartDate = FORMAT(GETDATE(), 'yyyy-MM-dd') AND EndDate = FORMAT(GETDATE(), 'yyyy-MM-dd')))
    ) AS myDerivedTable
    WHERE MaxRow = 1     
);

//nelze bohuzel pouzit jako parametr pro ITVF
CREATE VIEW CurrentValidityView AS
	SELECT NewPrefix, StartDate, EndDate, CompleteLink, FileToBeSaved,
	ROW_NUMBER() OVER (PARTITION BY NewPrefix ORDER BY StartDate DESC) AS MaxRow
	FROM TimetableLinks
	WHERE 	    
		((StartDate <= FORMAT(GETDATE(), 'yyyy-MM-dd') AND EndDate >= FORMAT(GETDATE(), 'yyyy-MM-dd'))
		OR
		(StartDate = FORMAT(GETDATE(), 'yyyy-MM-dd') AND EndDate = FORMAT(GETDATE(), 'yyyy-MM-dd')));

SELECT *
FROM dbo.ITVF_GetLinksCurrentValidity () 
ORDER BY FileToBeSaved;


//***********************************************
CREATE FUNCTION dbo.ITVF_GetLinksFutureValidity () 
RETURNS TABLE
AS
RETURN 
(
    SELECT NewPrefix, StartDate, CompleteLink, FileToBeSaved 
    FROM
	(
        SELECT NewPrefix, StartDate, EndDate, CompleteLink, FileToBeSaved
        FROM TimetableLinks
		WHERE StartDate > FORMAT(GETDATE(), 'yyyy-MM-dd')
    ) AS myDerivedTable     
);

SELECT *
FROM dbo.ITVF_GetLinksFutureValidity () 
ORDER BY FileToBeSaved;


//*****************************************************
CREATE FUNCTION dbo.ITVF_GetLinksReplacementService ()   
RETURNS TABLE
AS
RETURN 
(
    SELECT NewPrefix, StartDate, CompleteLink, FileToBeSaved, MaxRow
    FROM
	(
        SELECT NewPrefix, StartDate, EndDate, CompleteLink, FileToBeSaved,
		ROW_NUMBER() OVER (PARTITION BY NewPrefix ORDER BY StartDate DESC) AS MaxRow
        FROM TimetableLinks
		WHERE 	    
        ((StartDate <= FORMAT(GETDATE(), 'yyyy-MM-dd') AND EndDate >= FORMAT(GETDATE(), 'yyyy-MM-dd'))
        OR
        (StartDate = FORMAT(GETDATE(), 'yyyy-MM-dd') AND EndDate = FORMAT(GETDATE(), 'yyyy-MM-dd')))
		AND
		(CHARINDEX('_v', FileToBeSaved) > 0
        OR 
        CHARINDEX('X', FileToBeSaved) > 0
        OR 
        CHARINDEX('NAD', FileToBeSaved) > 0)		
    ) AS myDerivedTable
    WHERE MaxRow = 1     
);

SELECT *
FROM dbo.ITVF_GetLinksReplacementService () 
ORDER BY FileToBeSaved;


//*************************************************************  
CREATE FUNCTION dbo.ITVF_GetLinksWithoutReplacementService ()   
RETURNS TABLE
AS
RETURN 
(
    SELECT NewPrefix, StartDate, CompleteLink, FileToBeSaved, MaxRow
    FROM
	(
        SELECT NewPrefix, StartDate, EndDate, CompleteLink, FileToBeSaved,
		ROW_NUMBER() OVER (PARTITION BY NewPrefix ORDER BY StartDate DESC) AS MaxRow
        FROM TimetableLinks
		WHERE 	    
        ((StartDate <= FORMAT(GETDATE(), 'yyyy-MM-dd') AND EndDate >= FORMAT(GETDATE(), 'yyyy-MM-dd'))
        OR
        (StartDate = FORMAT(GETDATE(), 'yyyy-MM-dd') AND EndDate = FORMAT(GETDATE(), 'yyyy-MM-dd')))
		AND
		(CHARINDEX('_v', FileToBeSaved) = 0
        AND 
        CHARINDEX('X', FileToBeSaved) = 0
        AND 
        CHARINDEX('NAD', FileToBeSaved) = 0)		
    ) AS myDerivedTable
    WHERE MaxRow = 1     
);

SELECT *
FROM dbo.ITVF_GetLinksWithoutReplacementService () 
ORDER BY FileToBeSaved;